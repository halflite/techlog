<!DOCTYPE html>
<html>
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
  ActiveMQとQuarkus、Apache Camelで、画像アップロード処理をしたい。 その2 Consumer/Apache Camel編 &ndash; ひとり開発日記。

    </title>
    
    
    <meta name="description" property="og:description" content="TL;DR Quarkus - Start coding with code.quarkus.redhat.com で、雛形を作ります。 camel-quarkus-sjms2 / quarkus-artemis-jms を依存関係に含めます。 ルート用のクラスは、DI対象に含めます。 ActiveMQ Altemis用の設定を、application.propertiesに記します。 前回 ActiveMQとQuarkus、ApacheCamelで、画像アップロード処理をしたい。 その1 Producer 編 Apache CamelとQuarkusの第一歩 Camel Extensions for Quarkus と Camel K の入門 - 赤帽エンジニアブログ はい、この通りに、Maven/Gradeleでプロジェクトを作って、実行してみましょう。1 Quarkus - Start coding with code.quarkus.redhat.com Routeの修正 上記のサンプルだと、少々使いづらい。 Routesクラスを以下のように修正します。
継承する親クラスを EndpointRouteBuilder にします。2 タイプセーフで、「流れるようなインターフェース」でルートが書けるようになります。 クラスに @ApplicationScoped アノテーションを付けます。 RoutesクラスがDI対象に含まれます。 ActiveMQからのメッセージ受信 camel-quarkus-sjms2を依存関係に加えます。 諸々必要なコンポーネントが自動で入ります。 ActiveMQ/JMSを通じて、メッセージを受信するためのコンポーネントには、camel-activemq / camel-jmsがあります。 このコンポーネントには、Spring Frameworkのライブラリが依存で入ってしまうのです。 ネット上のサンプルプログラムは、Spring-BootベースのConsumerが多いからでしょうね。 quarkus-artemis-jmsを依存関係に加えます camel-quarkus-sjms2には、ActiveMQとの通信をする、ConnectionFactoryの実装クラスが入ってないのです。 Artemis JMSの記述のようにapplication.propertiesに設定を記述すると、ConnectionFactoryもDI対象になります。 Quarkus Artemis BOMは、Quarkusと違うので、別途依存関係に追加します。 @ApplicationScoped public class Routes extends EndpointRouteBuilder { private final ConnectionFactory connectionFactory; @Override public void configure() throws Exception { from(sjms2(&amp;#34;topic:upload.|">
    

    <meta name="apple-mobile-web-app-title" content="ひとり開発日記。">
    
    
    
    


    <link rel="stylesheet" href="/techlog/assets/syntax.css">
    <link rel="stylesheet" href="/techlog/assets/primer-build.css">
    <link rel="stylesheet" href="/techlog/assets/style.css">
    <link rel="stylesheet" href="/techlog/assets/custom_style.css">
  </head>


  <body class="bg-gray">
    <div id="holy" class="container-lg bg-white h-100">

      <div id="header" class="px-1 bg-white">
        <nav class="UnderlineNav UnderlineNav--right px-2">
  <a class="UnderlineNav-actions muted-link h2" href="https://halflite.github.io/techlog/">
    ひとり開発日記。
  </a>

  
  
</nav>

      </div>

      <div role="main" id="main" class="holy-main markdown-body px-4 bg-white">
        

<div class="Subhead">
  <div class="Subhead-heading">
    <div class="h1 mt-3 mb-1">ActiveMQとQuarkus、Apache Camelで、画像アップロード処理をしたい。 その2 Consumer/Apache Camel編</div>
  </div>
  <div class="Subhead-description">
    




<a href='/tags/java' class="muted-link">
  <span class="Label Label--gray">java</span>
</a>

<a href='/tags/quarkus' class="muted-link">
  <span class="Label Label--gray">quarkus</span>
</a>

<a href='/tags/apache-camel' class="muted-link">
  <span class="Label Label--gray">apache-camel</span>
</a>



    
    <div class="float-md-right">
      <span title="Lastmod: 2023-06-02. Published at: 2023-06-02.">
        
          Published: 2023-06-02
        
      </span>
    </div>
    
  </div>
</div>
<article>
  
  <section class="pb-6 mb-3 border-bottom">
    <h3 id="tldr">TL;DR</h3>
<ul>
<li><a href="https://code.quarkus.redhat.com/" title="Quarkus - Start coding with code.quarkus.redhat.com">Quarkus - Start coding with code.quarkus.redhat.com</a> で、雛形を作ります。</li>
<li><a href="https://mvnrepository.com/artifact/org.apache.camel.quarkus/camel-quarkus-sjms2"><code>camel-quarkus-sjms2</code></a> / <a href="https://mvnrepository.com/artifact/io.quarkiverse.artemis/quarkus-artemis-jms"><code>quarkus-artemis-jms</code></a> を依存関係に含めます。</li>
<li>ルート用のクラスは、DI対象に含めます。</li>
<li><code>ActiveMQ Altemis</code>用の設定を、<code>application.properties</code>に記します。</li>
</ul>
<h3 id="前回">前回</h3>
<ul>
<li><a href="/techlog/posts/20230529_jms_producer/">ActiveMQとQuarkus、ApacheCamelで、画像アップロード処理をしたい。 その1 Producer 編</a></li>
</ul>
<h3 id="apache-camelとquarkusの第一歩">Apache CamelとQuarkusの第一歩</h3>
<ul>
<li><a href="https://rheb.hatenablog.com/entry/2022/06/28/120434">Camel Extensions for Quarkus と Camel K の入門 - 赤帽エンジニアブログ</a>
<ul>
<li>はい、この通りに、Maven/Gradeleでプロジェクトを作って、実行してみましょう。<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></li>
<li><a href="https://code.quarkus.redhat.com/" title="Quarkus - Start coding with code.quarkus.redhat.com">Quarkus - Start coding with code.quarkus.redhat.com</a></li>
</ul>
</li>
</ul>
<h3 id="routeの修正">Routeの修正</h3>
<p>上記のサンプルだと、少々使いづらい。 <code>Routes</code>クラスを以下のように修正します。</p>
<ul>
<li>継承する親クラスを <code>EndpointRouteBuilder</code> にします。<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>
<ul>
<li>タイプセーフで、<a href="https://bliki-ja.github.io/FluentInterface/" title="流れるようなインタフェース - Martin Fowler's Bliki (ja)">「流れるようなインターフェース」</a>でルートが書けるようになります。</li>
</ul>
</li>
<li>クラスに <code>@ApplicationScoped</code> アノテーションを付けます。
<ul>
<li><code>Routes</code>クラスがDI対象に含まれます。</li>
</ul>
</li>
</ul>
<h3 id="activemqからのメッセージ受信">ActiveMQからのメッセージ受信</h3>
<ul>
<li><a href="https://mvnrepository.com/artifact/org.apache.camel.quarkus/camel-quarkus-sjms2"><code>camel-quarkus-sjms2</code></a>を依存関係に加えます。
<ul>
<li>諸々必要なコンポーネントが自動で入ります。</li>
<li>ActiveMQ/JMSを通じて、メッセージを受信するためのコンポーネントには、<a href="https://camel.apache.org/components/3.20.x/activemq-component.html"><code>camel-activemq</code></a> / <a href="https://camel.apache.org/components/3.20.x/jms-component.html"><code>camel-jms</code></a>があります。
<ul>
<li>このコンポーネントには、<code>Spring Framework</code>のライブラリが依存で入ってしまうのです。</li>
<li>ネット上のサンプルプログラムは、<code>Spring-Boot</code>ベースのConsumerが多いからでしょうね。</li>
</ul>
</li>
</ul>
</li>
<li><a href="https://mvnrepository.com/artifact/io.quarkiverse.artemis/quarkus-artemis-jms"><code>quarkus-artemis-jms</code></a>を依存関係に加えます
<ul>
<li><code>camel-quarkus-sjms2</code>には、ActiveMQとの通信をする、<code>ConnectionFactory</code>の実装クラスが入ってないのです。</li>
<li><a href="https://ja.quarkus.io/guides/jms#artemis-jms">Artemis JMS</a>の記述のように<code>application.properties</code>に設定を記述すると、<code>ConnectionFactory</code>もDI対象になります。</li>
<li><a href="https://mvnrepository.com/artifact/io.quarkiverse.artemis/quarkus-artemis-bom">Quarkus Artemis BOM</a>は、Quarkusと違うので、別途依存関係に追加します。</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@ApplicationScoped</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Routes</span> <span style="color:#66d9ef">extends</span> EndpointRouteBuilder <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ConnectionFactory connectionFactory<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    from<span style="color:#f92672">(</span>sjms2<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;topic:upload.image&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">connectionFactory</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">connectionFactory</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// TODO 何かを処理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">.</span><span style="color:#a6e22e">end</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">@Inject</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MainRoute</span><span style="color:#f92672">(</span>ConnectionFactory connectionFactory<span style="color:#f92672">,)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">connectionFactory</span> <span style="color:#f92672">=</span> connectionFactory<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>Routes</code>クラスは、このような記述になるでしょうか。</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>コンソールにログが出ますので、それで動作確認でしょうか。&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://camel.apache.org/manual/Endpoint-dsl.html" title="Endpoint DSL :: Apache Camel">Endpoint DSL :: Apache Camel</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

  </section>

  <section>
    
      
    
  </section>
</article>

      </div>

      <div id="side" class="pr-1 bg-white">
        <aside class="pr-3">
          
  
    <div id="toc" class="Box Box--blue mb-3">
      <b>ActiveMQとQuarkus、Apache Camelで、画像アップロード処理をしたい。 その2 Consumer/Apache Camel編</b><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#tldr">TL;DR</a></li>
        <li><a href="#前回">前回</a></li>
        <li><a href="#apache-camelとquarkusの第一歩">Apache CamelとQuarkusの第一歩</a></li>
        <li><a href="#routeの修正">Routeの修正</a></li>
        <li><a href="#activemqからのメッセージ受信">ActiveMQからのメッセージ受信</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
  

  
    <div>
      
    </div>
  

        </aside>
      </div>

      <div id="footer" class="pt-2 pb-3 bg-white text-center">
        

  <span class="text-small text-gray">
    

    Powered by the
    <a href="https://github.com/qqhann/hugo-primer" class="link-gray-dark">Hugo-Primer</a> theme for
    <a href="https://gohugo.io" class="link-gray-dark">Hugo</a>.
  </span>


      </div>
    </div>

    
    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script>
    
  </body>
</html>
